<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>proxygen: `folly/ProducerConsumerQueue.h`</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">proxygen
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_proxygen_folly_folly_docs_ProducerConsumerQueue.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">`folly/ProducerConsumerQueue.h` </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <code><a class="el" href="structfolly_1_1ProducerConsumerQueue.html">folly::ProducerConsumerQueue</a></code> class is a one-producer one-consumer queue with very low synchronization overhead.</p>
<p>The queue must be created with a fixed maximum size (and allocates that many cells of sizeof(T)), and it provides just a few simple operations:</p>
<ul>
<li><code>read</code>: Attempt to read the value at the front to the queue into a variable, returns <code>false</code> iff queue was empty.</li>
<li><code>write</code>: Emplace a value at the end of the queue, returns <code>false</code> iff the queue was full.</li>
<li><code>frontPtr</code>: Retrieve a pointer to the item at the front of the queue, or <code>nullptr</code> if it is empty.</li>
<li><code>popFront</code>: Remove the item from the front of the queue (queue must not be empty).</li>
<li><code>isEmpty</code>: Check if the queue is empty.</li>
<li><code>isFull</code>: Check if the queue is full.</li>
<li><code>sizeGuess</code>: Returns the number of entries in the queue. Because of the way we coordinate threads, this guess could be slightly wrong when called by the producer/consumer thread, and it could be wildly inaccurate if called from any other threads. Hence, only call from producer/consumer threads!</li>
</ul>
<p>All of these operations are wait-free. The read operations (including <code>frontPtr</code> and <code>popFront</code>) and write operations must only be called by the reader and writer thread, respectively. <code>isFull</code>, <code>isEmpty</code>, and <code>sizeGuess</code> may be called by either thread, but the return values from <code>read</code>, <code>write</code>, or <code>frontPtr</code> are sufficient for most cases.</p>
<p><code>write</code> may fail if the queue is full, and <code>read</code> may fail if the queue is empty, so in many situations it is important to choose the queue size such that the queue filling or staying empty for long is unlikely.</p>
<h3>Example</h3>
<hr/>
<p><a class="el" href="structA.html">A</a> toy example that doesn't really do anything useful:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;folly::ProducerConsumerQueue&lt;folly::fbstring&gt; queue{size};</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;std::thread reader([&amp;queue] {</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  for (;;) {</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    folly::fbstring str;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    while (!queue.read(str)) {</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;      //spin until we get a value</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;      continue;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    }</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;    sink(str);</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;  }</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;});</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;// producer thread:</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;for (;;) {</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;  folly::fbstring str = source();</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;  while (!queue.write(str)) {</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    //spin until the queue has room</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    continue;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;  }</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;}</div></div><!-- fragment --><p>Alternatively, the consumer may be written as follows to use the 'front' value in place, thus avoiding moves or copies:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;std::thread reader([&amp;queue] {</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  for (;;) {</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    folly::fbstring* pval;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    do {</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;      pval = queue.frontPtr();</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    } while (!pval); // spin until we get a value;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    sink(*pval);</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    queue.popFront();</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;  }</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;});</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
