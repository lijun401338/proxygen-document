<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>proxygen: proxygen/folly/folly/docs/Executors.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">proxygen
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('Executors_8md.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">proxygen/folly/folly/docs/Executors.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="Executors_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&lt;section class=&quot;dex_document&quot;&gt;&lt;h1&gt;Thread pools &amp;amp; Executors&lt;/h1&gt;&lt;p class=&quot;dex_introduction&quot;&gt;Run your concurrent code in a performant way&lt;/p&gt;&lt;h2 id=&quot;all-about-thread-pools&quot;&gt;All about thread pools &lt;a href=&quot;#all-about-thread-pools&quot; class=&quot;headerLink&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;&lt;h3 id=&quot;how-do-i-use-the-thread&quot;&gt;How do I use the thread pools? &lt;a href=&quot;#how-do-i-use-the-thread&quot; class=&quot;headerLink&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;&lt;p&gt;Wangle provides two concrete thread pools (IOThreadPoolExecutor, CPUThreadPoolExecutor) as well as building them in as part of a complete async framework.  Generally you might want to grab the global executor, and use it with a future, like this:&lt;/p&gt;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;&lt;div class=&quot;remarkup-code-block&quot; data-code-lang=&quot;php&quot;&gt;&lt;pre class=&quot;remarkup-code&quot;&gt;&lt;span class=&quot;no&quot;&gt;auto&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot; data-symbol-name=&quot;someFutureFunction&quot;&gt;someFutureFunction&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;nf&quot; data-symbol-name=&quot;via&quot;&gt;via&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nf&quot; data-symbol-name=&quot;getCPUExecutor&quot;&gt;getCPUExecutor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()).&lt;/span&gt;&lt;span class=&quot;nf&quot; data-symbol-name=&quot;then&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(...)&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;&lt;p&gt;Or maybe you need to construct a thrift/memcache client, and need an event base:&lt;/p&gt;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;&lt;div class=&quot;remarkup-code-block&quot; data-code-lang=&quot;php&quot;&gt;&lt;pre class=&quot;remarkup-code&quot;&gt;&lt;span class=&quot;no&quot;&gt;auto&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot; data-symbol-name=&quot;getClient&quot;&gt;getClient&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nf&quot; data-symbol-name=&quot;getIOExecutor&quot;&gt;getIOExecutor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot; data-symbol-name=&quot;getEventBase&quot;&gt;getEventBase&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot; data-symbol-name=&quot;callSomeFunction&quot;&gt;callSomeFunction&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...)&lt;/span&gt;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;         &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot; data-symbol-name=&quot;via&quot;&gt;via&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nf&quot; data-symbol-name=&quot;getCPUExecutor&quot;&gt;getCPUExecutor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;         &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot; data-symbol-name=&quot;then&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;([](&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Result&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&amp;#123;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;....&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;something&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;&lt;h3 id=&quot;vs-c-11-s-std-launch&quot;&gt;vs. C++11&amp;#039;s std::launch &lt;a href=&quot;#vs-c-11-s-std-launch&quot; class=&quot;headerLink&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;&lt;p&gt;The current C++11 std::launch only has two modes: async or deferred.  In a production system, neither is what you want:  async will launch a new thread for every launch without limit, while deferred will defer the work until it is needed lazily, but then do the work &lt;strong&gt;in the current thread synchronously&lt;/strong&gt; when it is needed.&lt;/p&gt;</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;&lt;p&gt;Wangle&amp;#039;s thread pools always launch work as soon as possible, have limits to the maximum number of tasks / threads allowed, so we will never use more threads than absolutely needed.  See implementation details below about each type of executor.&lt;/p&gt;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;&lt;h3 id=&quot;why-do-we-need-yet-anoth&quot;&gt;Why do we need yet another set of thread pools? &lt;a href=&quot;#why-do-we-need-yet-anoth&quot; class=&quot;headerLink&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;&lt;p&gt;Unfortunately none of the existing thread pools had every feature needed - things based on pipes are too slow.   Several older ones didn&amp;#039;t support std::function.&lt;/p&gt;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;&lt;h3 id=&quot;why-do-we-need-several-d&quot;&gt;Why do we need several different types of thread pools? &lt;a href=&quot;#why-do-we-need-several-d&quot; class=&quot;headerLink&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;&lt;p&gt;If you want epoll support, you need an fd - event_fd is the latest notification hotness.   Unfortunately, an active fd triggers all the epoll loops it is in, leading to thundering herd - so if you want a fair queue (one queue total vs. one queue per worker thread), you need to use some kind of semaphore.  Unfortunately semaphores can&amp;#039;t be put in epoll loops, so they are incompatible with IO.   Fortunately, you usually want to separate the IO and CPU bound work anyway to give stronger tail latency guarantees on IO.&lt;/p&gt;</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;&lt;h3 id=&quot;iothreadpoolexecutor&quot;&gt;IOThreadPoolExecutor &lt;a href=&quot;#iothreadpoolexecutor&quot; class=&quot;headerLink&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;&lt;ul&gt;</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;&lt;li&gt;Uses event_fd for notification, and waking an epoll loop.&lt;/li&gt;</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;&lt;li&gt;There is one queue (NotificationQueue specifically) per thread/epoll.&lt;/li&gt;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;&lt;li&gt;If the thread is already running and not waiting on epoll, we don&amp;#039;t make any additional syscalls to wake up the loop, just put the new task in the queue.&lt;/li&gt;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;&lt;li&gt;If any thread has been waiting for more than a few seconds, its stack is madvised away.   Currently however tasks are scheduled round robin on the queues, so unless there is &lt;strong&gt;no&lt;/strong&gt; work going on, this isn&amp;#039;t very effective.&lt;/li&gt;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;&lt;li&gt;::getEventBase() will return an EventBase you can schedule IO work on directly, chosen round-robin.&lt;/li&gt;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;&lt;li&gt;Since there is one queue per thread, there is hardly any contention on the queues - so a simple spinlock around an std::deque is used for the tasks.  There is no max queue size.&lt;/li&gt;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;&lt;li&gt;By default, there is one thread per core - it usually doesn&amp;#039;t make sense to have more IO threads than this, assuming they don&amp;#039;t block.&lt;/li&gt;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;&lt;/ul&gt;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;&lt;h3 id=&quot;cputhreadpoolexecutor&quot;&gt;CPUThreadPoolExecutor &lt;a href=&quot;#cputhreadpoolexecutor&quot; class=&quot;headerLink&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;&lt;ul&gt;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;&lt;li&gt;A single queue backed by folly/LifoSem and folly/MPMC queue.  Since there is only a single queue, contention can be quite high, since all the worker threads and all the producer threads hit the same queue.  MPMC queue excels in this situation.  MPMC queue dictates a max queue size.&lt;/li&gt;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;&lt;li&gt;LifoSem wakes up threads in Lifo order - i.e. there are only few threads as necessary running, and we always try to reuse the same few threads for better cache locality.&lt;/li&gt;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;&lt;li&gt;Inactive threads have their stack madvised away.  This works quite well in combination with Lifosem - it almost doesn&amp;#039;t matter if more threads than are necessary are specified at startup.&lt;/li&gt;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;&lt;li&gt;stop() will finish all outstanding tasks at exit&lt;/li&gt;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;&lt;li&gt;Supports priorities - priorities are implemented as multiple queues - each worker thread checks the highest priority queue first.  Threads themselves don&amp;#039;t have priorities set, so a series of long running low priority tasks could still hog all the threads.  (at last check pthreads thread priorities didn&amp;#039;t work very well)&lt;/li&gt;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;&lt;/ul&gt;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;&lt;h3 id=&quot;threadpoolexecutor&quot;&gt;ThreadPoolExecutor &lt;a href=&quot;#threadpoolexecutor&quot; class=&quot;headerLink&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;&lt;p&gt;Base class that contains the thread startup/shutdown/stats logic, since this is pretty disjoint from how tasks are actually run&lt;/p&gt;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;&lt;h3 id=&quot;observers&quot;&gt;Observers &lt;a href=&quot;#observers&quot; class=&quot;headerLink&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;&lt;p&gt;An observer interface is provided to listen for thread start/stop events.  This is useful to create objects that should be one-per-thread, but also have them work correctly if threads are added/removed from the thread pool.&lt;/p&gt;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;&lt;h3 id=&quot;stats&quot;&gt;Stats &lt;a href=&quot;#stats&quot; class=&quot;headerLink&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;&lt;p&gt;PoolStats are provided to get task count, running time, waiting time, etc.&lt;/p&gt;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;&lt;/section&gt;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="Executors_8md.html">Executors.md</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
