<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>proxygen: folly::MPMCQueue&lt; T, Atom, Dynamic &gt; Class Template Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">proxygen
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="hierarchy.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('classfolly_1_1MPMCQueue.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pri-types">Private Types</a> &#124;
<a href="#friends">Friends</a> &#124;
<a href="classfolly_1_1MPMCQueue-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">folly::MPMCQueue&lt; T, Atom, Dynamic &gt; Class Template Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p><code>#include &lt;<a class="el" href="MPMCQueue_8h_source.html">MPMCQueue.h</a>&gt;</code></p>
<div class="dynheader">
Inheritance diagram for folly::MPMCQueue&lt; T, Atom, Dynamic &gt;:</div>
<div class="dyncontent">
 <div class="center">
  <img src="classfolly_1_1MPMCQueue.png" usemap="#folly::MPMCQueue_3C_20T_2C_20Atom_2C_20Dynamic_20_3E_map" alt=""/>
  <map id="folly::MPMCQueue_3C_20T_2C_20Atom_2C_20Dynamic_20_3E_map" name="folly::MPMCQueue&lt; T, Atom, Dynamic &gt;_map">
<area href="classfolly_1_1detail_1_1MPMCQueueBase.html" alt="folly::detail::MPMCQueueBase&lt; MPMCQueue&lt; T, Atom, Dynamic &gt; &gt;" shape="rect" coords="0,0,410,24"/>
</map>
 </div></div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:ad59525032a5b3e42b7373b348745620d"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfolly_1_1MPMCQueue.html#ad59525032a5b3e42b7373b348745620d">MPMCQueue</a> (size_t queueCapacity)</td></tr>
<tr class="separator:ad59525032a5b3e42b7373b348745620d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a93c297321e12763cde120fdd1e6cd7d2"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfolly_1_1MPMCQueue.html#a93c297321e12763cde120fdd1e6cd7d2">MPMCQueue</a> () noexcept</td></tr>
<tr class="separator:a93c297321e12763cde120fdd1e6cd7d2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pri-types"></a>
Private Types</h2></td></tr>
<tr class="memitem:af7318f6cadff13386b217f248f8177f4"><td class="memItemLeft" align="right" valign="top">using&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfolly_1_1MPMCQueue.html#af7318f6cadff13386b217f248f8177f4">Slot</a> = <a class="el" href="structfolly_1_1detail_1_1SingleElementQueue.html">detail::SingleElementQueue</a>&lt; <a class="el" href="namespacefolly.html#a0652a9c51b69e7a13d40ccbcb139bc55">T</a>, <a class="el" href="ConcurrentHashMapTest_8cpp.html#a98ac53dd3c18b4046e7c5cb0bcb64b75">Atom</a> &gt;</td></tr>
<tr class="separator:af7318f6cadff13386b217f248f8177f4"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="friends"></a>
Friends</h2></td></tr>
<tr class="memitem:a43dea8ed89972151f9703ff0d2f9d3bf"><td class="memItemLeft" align="right" valign="top">class&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfolly_1_1MPMCQueue.html#a43dea8ed89972151f9703ff0d2f9d3bf">detail::MPMCPipelineStageImpl&lt; T &gt;</a></td></tr>
<tr class="separator:a43dea8ed89972151f9703ff0d2f9d3bf"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><h3>template&lt;typename T, template&lt; typename &gt; class Atom = std::atomic, bool Dynamic = false&gt;<br />
class folly::MPMCQueue&lt; T, Atom, Dynamic &gt;</h3>

<p><a class="el" href="classfolly_1_1MPMCQueue.html">MPMCQueue&lt;T&gt;</a> is a high-performance bounded concurrent queue that supports multiple producers, multiple consumers, and optional blocking. The queue has a fixed capacity, for which all memory will be allocated up front. The bulk of the work of enqueuing and dequeuing can be performed in parallel.</p>
<p><a class="el" href="classfolly_1_1MPMCQueue.html">MPMCQueue</a> is linearizable. That means that if a call to write(A) returns before a call to write(B) begins, then <a class="el" href="structA.html">A</a> will definitely end up in the queue before <a class="el" href="structfolly_1_1B.html">B</a>, and if a call to read(X) returns before a call to read(Y) is started, that <a class="el" href="structX.html">X</a> will be something from earlier in the queue than Y. This also means that if a read call returns a value, you can be sure that all previous elements of the queue have been assigned a reader (that reader might not yet have returned, but it exists).</p>
<p>The underlying implementation uses a ticket dispenser for the head and the tail, spreading accesses across N single-element queues to produce a queue with capacity N. The ticket dispensers use atomic increment, which is more robust to contention than a CAS loop. Each of the single-element queues uses its own CAS to serialize access, with an adaptive spin cutoff. When spinning fails on a single-element queue it uses futex()'s _BITSET operations to reduce unnecessary wakeups even if multiple waiters are present on an individual queue (such as when the <a class="el" href="classfolly_1_1MPMCQueue.html">MPMCQueue</a>'s capacity is smaller than the number of enqueuers or dequeuers).</p>
<p>In benchmarks (contained in tao/queues/ConcurrentQueueTests) it handles 1 to 1, 1 to N, N to 1, and N to M thread counts better than any of the alternatives present in fbcode, for both small (~10) and large capacities. In these benchmarks it is also faster than tbb::concurrent_bounded_queue for all configurations. When there are many more threads than cores, <a class="el" href="classfolly_1_1MPMCQueue.html">MPMCQueue</a> is <em>much</em> faster than the tbb queue because it uses futex() to block and unblock waiting threads, rather than spinning with sched_yield.</p>
<p>NOEXCEPT INTERACTION: tl;dr; If it compiles you're fine. Ticket-based queues separate the assignment of queue positions from the actual construction of the in-queue elements, which means that the T constructor used during enqueue must not throw an exception. This is enforced at compile time using type traits, which requires that T be adorned with accurate noexcept information. If your type does not use noexcept, you will have to wrap it in something that provides the guarantee. We provide an alternate safe implementation for types that don't use noexcept but that are marked <a class="el" href="structfolly_1_1IsRelocatable.html">folly::IsRelocatable</a> and std::is_nothrow_constructible, which is common for folly types. In particular, if you can declare FOLLY_ASSUME_FBVECTOR_COMPATIBLE then your type can be put in <a class="el" href="classfolly_1_1MPMCQueue.html">MPMCQueue</a>.</p>
<p>If you have a pool of N queue consumers that you want to shut down after the queue has drained, one way is to enqueue N sentinel values to the queue. If the producer doesn't know how many consumers there are you can enqueue one sentinel and then have each consumer requeue two sentinels after it receives it (by requeuing 2 the shutdown can complete in O(log P) time instead of O(P)). </p>

<p>Definition at line <a class="el" href="MPMCQueue_8h_source.html#l00106">106</a> of file <a class="el" href="MPMCQueue_8h_source.html">MPMCQueue.h</a>.</p>
</div><h2 class="groupheader">Member Typedef Documentation</h2>
<a class="anchor" id="af7318f6cadff13386b217f248f8177f4"></a>
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename T, template&lt; typename &gt; class Atom = std::atomic, bool Dynamic = false&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">using <a class="el" href="classfolly_1_1MPMCQueue.html">folly::MPMCQueue</a>&lt; <a class="el" href="namespacefolly.html#a0652a9c51b69e7a13d40ccbcb139bc55">T</a>, <a class="el" href="ConcurrentHashMapTest_8cpp.html#a98ac53dd3c18b4046e7c5cb0bcb64b75">Atom</a>, Dynamic &gt;::<a class="el" href="classfolly_1_1MPMCQueue.html#af7318f6cadff13386b217f248f8177f4">Slot</a> =  <a class="el" href="structfolly_1_1detail_1_1SingleElementQueue.html">detail::SingleElementQueue</a>&lt;<a class="el" href="namespacefolly.html#a0652a9c51b69e7a13d40ccbcb139bc55">T</a>, <a class="el" href="ConcurrentHashMapTest_8cpp.html#a98ac53dd3c18b4046e7c5cb0bcb64b75">Atom</a>&gt;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="MPMCQueue_8h_source.html#l00108">108</a> of file <a class="el" href="MPMCQueue_8h_source.html">MPMCQueue.h</a>.</p>

</div>
</div>
<h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="ad59525032a5b3e42b7373b348745620d"></a>
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename T, template&lt; typename &gt; class Atom = std::atomic, bool Dynamic = false&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classfolly_1_1MPMCQueue.html">folly::MPMCQueue</a>&lt; <a class="el" href="namespacefolly.html#a0652a9c51b69e7a13d40ccbcb139bc55">T</a>, <a class="el" href="ConcurrentHashMapTest_8cpp.html#a98ac53dd3c18b4046e7c5cb0bcb64b75">Atom</a>, Dynamic &gt;::<a class="el" href="classfolly_1_1MPMCQueue.html">MPMCQueue</a> </td>
          <td>(</td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>queueCapacity</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">explicit</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="MPMCQueue_8h_source.html#l00111">111</a> of file <a class="el" href="MPMCQueue_8h_source.html">MPMCQueue.h</a>.</p>
<div class="fragment"><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;      : detail::MPMCQueueBase&lt;MPMCQueue&lt;T, Atom, Dynamic&gt;&gt;(queueCapacity) {</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    this-&gt;stride_ = this-&gt;computeStride(queueCapacity);</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    this-&gt;slots_ = <span class="keyword">new</span> <a class="code" href="classfolly_1_1MPMCQueue.html#af7318f6cadff13386b217f248f8177f4">Slot</a>[queueCapacity + 2 * this-&gt;kSlotPadding];</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  }</div><div class="ttc" id="classfolly_1_1MPMCQueue_html_af7318f6cadff13386b217f248f8177f4"><div class="ttname"><a href="classfolly_1_1MPMCQueue.html#af7318f6cadff13386b217f248f8177f4">folly::MPMCQueue::Slot</a></div><div class="ttdeci">detail::SingleElementQueue&lt; T, Atom &gt; Slot</div><div class="ttdef"><b>Definition:</b> <a href="MPMCQueue_8h_source.html#l00108">MPMCQueue.h:108</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a93c297321e12763cde120fdd1e6cd7d2"></a>
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename T, template&lt; typename &gt; class Atom = std::atomic, bool Dynamic = false&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classfolly_1_1MPMCQueue.html">folly::MPMCQueue</a>&lt; <a class="el" href="namespacefolly.html#a0652a9c51b69e7a13d40ccbcb139bc55">T</a>, <a class="el" href="ConcurrentHashMapTest_8cpp.html#a98ac53dd3c18b4046e7c5cb0bcb64b75">Atom</a>, Dynamic &gt;::<a class="el" href="classfolly_1_1MPMCQueue.html">MPMCQueue</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">noexcept</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="MPMCQueue_8h_source.html#l00117">117</a> of file <a class="el" href="MPMCQueue_8h_source.html">MPMCQueue.h</a>.</p>
<div class="fragment"><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;{}</div></div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Friends And Related Function Documentation</h2>
<a class="anchor" id="a43dea8ed89972151f9703ff0d2f9d3bf"></a>
<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename T, template&lt; typename &gt; class Atom = std::atomic, bool Dynamic = false&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">friend class <a class="el" href="classfolly_1_1detail_1_1MPMCPipelineStageImpl.html">detail::MPMCPipelineStageImpl</a>&lt; <a class="el" href="namespacefolly.html#a0652a9c51b69e7a13d40ccbcb139bc55">T</a> &gt;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">friend</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="MPMCQueue_8h_source.html#l00107">107</a> of file <a class="el" href="MPMCQueue_8h_source.html">MPMCQueue.h</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>proxygen/folly/folly/<a class="el" href="MPMCQueue_8h_source.html">MPMCQueue.h</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacefolly.html">folly</a></li><li class="navelem"><a class="el" href="classfolly_1_1MPMCQueue.html">MPMCQueue</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
